#!/usr/bin/env python2

from __future__ import print_function
from math import floor
import gtk, os

backlight = '/sys/class/backlight/intel_backlight'
max_bright = int( open(os.path.join(backlight, 'max_brightness')).readline() )
icon = gtk.status_icon_new_from_icon_name('video-display')
menu = gtk.Menu()

def set_tooltip(b=None):
    if b is None:
        b = open(os.path.join(backlight, 'brightness')).readline().strip()
    value = '{:.1f}'.format(float(b) / max_bright)
    print(b, max_bright, value)
    icon.set_tooltip_text("Brightness: "+value)

def set_bright(b):
    print('Setting brightness: ', b)

    value = int(floor(b * max_bright))

    print('Actual: ', value)

    try:
        open(os.path.join(backlight, 'brightness'), 'w').write(str(value))
    except IOError:
        print('Could not set brightness.')

    set_tooltip(value)

def popup(data, btn, time):
    menu.popup(None, None, None, btn, time)

def make_menu():
    for i in range(1, 11):
        step = 0.1 * i
        item = gtk.MenuItem('{:.1f}'.format(step))
        menu.append(item)
        item.connect_object('activate', set_bright, step)
        item.show()

if __name__ == '__main__':
    make_menu()
    icon.connect('popup-menu', popup)
    set_tooltip()
    gtk.main()
