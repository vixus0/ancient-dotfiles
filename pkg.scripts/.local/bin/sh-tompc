#!/bin/bash

# Convert to 16-bit Signed Integer PCM (dither)
cmd="sox --buffer 65536 --multi-threaded --norm INFILE -b 16 OUTFILE rate 44100 dither -s"
dext="wav"
dest="$1"
tmp="/tmp/sox.${dext}"

for f in `find . -name "*.wav" -o -name "*.ogg" -o -name "*.mp3" | cut -c3-`; do
  file="${f##*/}"
  fname="${file%.*}"
  fname="${fname##*__}" # dumb freesound names
  fext="${file##*.}"
  fdir="${f%/*}"
  fpre="${fdir##*/}"

  dst="$dest/$fdir/${fname}.${dext}"

  if [[ -n `soxi $f | grep '16-bit Signed Integer PCM'` ]] || [[ -f $dst ]]; then
    echo "SKIP $f"
    continue
  fi

  sox="${cmd/INFILE/$f}"
  sox="${sox/OUTFILE/$tmp}"

  $sox

  if [[ -f $tmp ]]; then
    mkdir -p "$dest/$fdir"
    mv $tmp $dst 
    echo "OK $f $dst"
  else
    echo "ERROR $f"
  fi
done
